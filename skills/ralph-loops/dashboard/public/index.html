<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Q Dashboard - Ralph Loop Monitor</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #333;
    }
    
    h1 {
      color: #f59e0b;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .stats {
      display: flex;
      gap: 20px;
    }
    
    .stat {
      background: #252540;
      padding: 10px 20px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #f59e0b;
    }
    
    .stat-label {
      font-size: 12px;
      color: #888;
    }
    
    section {
      margin-bottom: 30px;
    }
    
    h2 {
      color: #f59e0b;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .loop-grid {
      display: grid;
      gap: 15px;
    }
    
    .loop-card {
      background: #252540;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #333;
      transition: all 0.2s;
    }
    
    .loop-card:hover {
      border-color: #f59e0b;
    }
    
    .loop-card.running {
      border-left: 4px solid #f59e0b;
    }
    
    .loop-card.success {
      border-left: 4px solid #22c55e;
    }
    
    .loop-card.failed {
      border-left: 4px solid #ef4444;
    }
    
    .loop-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    
    .loop-id {
      font-family: monospace;
      font-size: 14px;
      color: #888;
    }
    
    .loop-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .loop-status.running {
      background: #22c55e33;
      color: #22c55e;
    }
    
    .loop-status.completed, .loop-status.done {
      background: #3b82f633;
      color: #3b82f6;
    }
    
    .loop-status.maxed {
      background: #eab30833;
      color: #eab308;
    }
    
    .loop-status.stopped {
      background: #ef444433;
      color: #ef4444;
    }
    
    .loop-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .metric {
      text-align: center;
    }
    
    .metric-value {
      font-size: 20px;
      font-weight: bold;
      color: #fff;
    }
    
    .metric-label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
    }
    
    .loop-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #333;
    }
    
    button {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .btn-kill {
      background: #ef4444;
      color: white;
    }
    
    .btn-kill:hover {
      background: #dc2626;
    }
    
    .btn-view {
      background: #3b82f6;
      color: white;
    }
    
    .btn-view:hover {
      background: #2563eb;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .refresh-info {
      font-size: 12px;
      color: #666;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      padding: 20px;
      overflow: auto;
    }
    
    .modal.active {
      display: block;
    }
    
    .modal-content {
      background: #252540;
      max-width: 900px;
      margin: 20px auto;
      border-radius: 12px;
      padding: 20px;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #333;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
    }
    
    .iteration-list {
      max-height: 500px;
      overflow-y: auto;
    }
    
    .iteration {
      padding: 10px;
      border-bottom: 1px solid #333;
      display: grid;
      grid-template-columns: 60px 1fr 100px 100px;
      gap: 15px;
      align-items: center;
    }
    
    .iteration:last-child {
      border-bottom: none;
    }
    
    .iteration-num {
      font-weight: bold;
      color: #f59e0b;
    }
    
    .iteration-time {
      color: #888;
      font-size: 13px;
    }
    
    .iteration-tokens, .iteration-duration {
      text-align: right;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üîÆ Q Dashboard <span style="font-weight:normal;color:#888">‚Äî Ralph Loop Monitor</span></h1>
      <div class="stats" id="stats">
        <div class="stat">
          <div class="stat-value" id="stat-running">-</div>
          <div class="stat-label">Running</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-archived">-</div>
          <div class="stat-label">Archived</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-tokens">-</div>
          <div class="stat-label">Total Tokens</div>
        </div>
      </div>
    </header>
    
    <section id="active-section">
      <h2>üü¢ Running Loops</h2>
      <div class="loop-grid" id="active-loops"></div>
    </section>
    
    <section id="archived-section">
      <h2>üìÅ Recent Archived</h2>
      <div class="loop-grid" id="archived-loops"></div>
    </section>
    
    <p class="refresh-info">Auto-refreshes every second</p>
  </div>
  
  <!-- History Modal -->
  <div class="modal" id="history-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Loop History</h3>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <div class="iteration-list" id="iteration-list"></div>
    </div>
  </div>

  <script>
    const API_BASE = '/api/loops';
    
    function formatTokens(n) {
      if (!n) return '0';
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return n.toString();
    }
    
    function formatDuration(ms) {
      if (!ms) return '0s';
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      if (hours > 0) return `${hours}h ${minutes % 60}m`;
      if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
      return `${seconds}s`;
    }
    
    function formatTime(isoString) {
      if (!isoString) return '-';
      const d = new Date(isoString);
      return d.toLocaleString();
    }
    
    function renderLoopCard(loop, isActive) {
      const status = loop.status || (loop.done ? 'completed' : 'running');
      const displayName = loop.name || loop.id;
      const borderClass = status === 'running' ? 'running' : (loop.isSuccess ? 'success' : 'failed');
      return `
        <div class="loop-card ${borderClass}">
          <div class="loop-header">
            <div>
              <div class="loop-id" style="font-weight:${loop.name ? 'bold' : 'normal'};color:${loop.name ? '#f59e0b' : '#888'}">${displayName}</div>
              ${loop.name ? `<div style="color:#666;font-size:11px;font-family:monospace">${loop.id}</div>` : ''}
              <div style="color:#888;font-size:12px;margin-top:4px">
                Started: ${formatTime(loop.started)}
              </div>
            </div>
            <span class="loop-status ${status}">${status}</span>
          </div>
          
          <div class="loop-metrics">
            <div class="metric">
              <div class="metric-value">${loop.iteration || 0}</div>
              <div class="metric-label">Iterations</div>
            </div>
            <div class="metric">
              <div class="metric-value">${formatTokens(loop.totalTokens)}</div>
              <div class="metric-label">Tokens</div>
            </div>
            <div class="metric">
              <div class="metric-value" style="font-size:28px;color:${status === 'running' ? '#f59e0b' : loop.isSuccess ? '#22c55e' : '#ef4444'}">${status === 'running' ? '‚óå' : loop.isSuccess ? '‚úì' : '‚úó'}</div>
              <div class="metric-label">Result</div>
            </div>
            <div class="metric">
              <div class="metric-value">${formatDuration(loop.totalDurationMs)}</div>
              <div class="metric-label">Duration</div>
            </div>
          </div>
          
          <div class="loop-actions">
            ${isActive && status === 'running' ? `<button class="btn-kill" onclick="killLoop('${loop.id}')">‚èπÔ∏è Kill</button>` : ''}
            <button class="btn-view" onclick="viewHistory('${loop.id}')">üìã History</button>
          </div>
        </div>
      `;
    }
    
    async function loadLoops() {
      try {
        const res = await fetch(API_BASE);
        const data = await res.json();
        
        if (!data.success) {
          console.error('Failed to load loops:', data.error);
          return;
        }
        
        const { active, archived, stats } = data.data;
        
        // Update stats
        document.getElementById('stat-running').textContent = stats.runningCount || 0;
        document.getElementById('stat-archived').textContent = stats.archivedCount || 0;
        document.getElementById('stat-tokens').textContent = formatTokens(stats.totalTokens);
        
        // Render active loops (only truly running ones)
        const activeContainer = document.getElementById('active-loops');
        const runningLoops = active.filter(l => l.status === 'running');
        if (runningLoops.length === 0) {
          activeContainer.innerHTML = `
            <div class="empty-state">
              <div class="icon">üîÑ</div>
              <div>No Ralph loops running</div>
              <div style="margin-top:10px;font-size:13px">Start one with sessions_spawn or ralph-loop.mjs</div>
            </div>
          `;
        } else {
          activeContainer.innerHTML = runningLoops.map(l => renderLoopCard(l, true)).join('');
        }
        
        // Add recently completed (from /tmp but done) to archived
        const recentlyCompleted = active.filter(l => l.status !== 'running');
        
        // Render archived loops (include recently completed from /tmp)
        const archivedContainer = document.getElementById('archived-loops');
        const allArchived = [...recentlyCompleted, ...archived]
          .sort((a, b) => new Date(b.started) - new Date(a.started));
        if (allArchived.length === 0) {
          archivedContainer.innerHTML = `
            <div class="empty-state">
              <div class="icon">üì≠</div>
              <div>No archived loops yet</div>
            </div>
          `;
        } else {
          archivedContainer.innerHTML = allArchived.map(l => renderLoopCard(l, false)).join('');
        }
        
      } catch (e) {
        console.error('Error loading loops:', e);
      }
    }
    
    async function killLoop(loopId) {
      if (!confirm(`Kill loop ${loopId}?`)) return;
      
      try {
        const res = await fetch(`${API_BASE}/${loopId}/kill`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
          alert('Loop killed');
          loadLoops();
        } else {
          alert('Failed to kill: ' + data.error);
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    async function viewHistory(loopId) {
      try {
        const res = await fetch(`${API_BASE}/${loopId}/history`);
        const data = await res.json();
        
        if (!data.success) {
          alert('Failed to load history');
          return;
        }
        
        const { iterations, summary } = data.data;
        
        document.getElementById('modal-title').textContent = `Loop: ${loopId}`;
        
        const listHtml = iterations.length === 0 
          ? '<div class="empty-state">No iterations recorded</div>'
          : iterations.map((it, i) => `
            <div class="iteration">
              <div class="iteration-num">#${it.iteration || i + 1}</div>
              <div class="iteration-time">${formatTime(it.timestamp)}</div>
              <div class="iteration-tokens">${formatTokens(it.tokens)} tok</div>
              <div class="iteration-duration">${formatDuration(it.durationMs)}</div>
            </div>
          `).join('');
        
        document.getElementById('iteration-list').innerHTML = listHtml;
        document.getElementById('history-modal').classList.add('active');
        
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }
    
    function closeModal() {
      document.getElementById('history-modal').classList.remove('active');
    }
    
    // Close modal on background click
    document.getElementById('history-modal').addEventListener('click', (e) => {
      if (e.target.id === 'history-modal') closeModal();
    });
    
    // Initial load and auto-refresh
    loadLoops();
    setInterval(loadLoops, 3000); // 3s to allow clicking
  </script>
</body>
</html>
