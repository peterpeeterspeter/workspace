#!/bin/bash
# Universal WordPress Publishing - Works on ALL sites with full metadata

TASK_ID=$1
TASK_TITLE=$2

# Source skills integration
source /root/.openclaw/workspace/agents/shared/skills-integration.sh

# Log setup
LOG_DIR="/root/.openclaw/workspace/tasks/logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/${TASK_ID}.log"

echo "=== $(date '+%Y-%m-%d %H:%M:%S') ===" >> "$LOG_FILE"
echo "Vision: Universal WordPress Publishing (All Sites)" >> "$LOG_FILE"
echo "Task: ${TASK_TITLE}" >> "$LOG_FILE"

# Find draft articles
DRAFT_DIR="/root/.openclaw/workspace/drafts"

if [ ! -d "$DRAFT_DIR" ]; then
  echo "ERROR: Drafts directory not found" >> "$LOG_FILE"
  exit 1
fi

DRAFT_COUNT=$(find "$DRAFT_DIR" -name "*.md" -type f | wc -l)
echo "Found ${DRAFT_COUNT} draft articles" >> "$LOG_FILE"

if [ "$DRAFT_COUNT" -eq 0 ]; then
  echo "ERROR: No draft articles found" >> "$LOG_FILE"
  exit 1
fi

PUBLISHED_COUNT=0
FAILED_COUNT=0

# Process each draft
for draft_file in "$DRAFT_DIR"/*.md; do
  if [ ! -f "$draft_file" ]; then
    continue
  fi

  draft_name=$(basename "$draft_file" .md)
  echo "" >> "$LOG_FILE"
  echo "Processing: ${draft_name}" >> "$LOG_FILE"

  # Convert markdown to HTML with metadata
  HTML_RESULT=$(python3 /root/.openclaw/workspace/agents/shared/md2html-fixed.py "$draft_file" 2>> "$LOG_FILE")

  if ! echo "$HTML_RESULT" | jq -e '.html' > /dev/null 2>&1; then
    echo "ERROR: Failed to convert markdown" >> "$LOG_FILE"
    ((FAILED_COUNT++))
    continue
  fi

  # Extract all data
  TITLE=$(echo "$HTML_RESULT" | jq -r '.metadata.title // empty')
  HTML_CONTENT=$(echo "$HTML_RESULT" | jq -r '.html // empty')
  META_DESC=$(echo "$HTML_RESULT" | jq -r '.metadata.description // empty')
  KEYWORDS=$(echo "$HTML_RESULT" | jq -r '.metadata.keywords // []')
  TARGET_SITE=$(echo "$HTML_RESULT" | jq -r '.metadata.site // empty')

  # Default values
  if [ -z "$TITLE" ] || [ "$TITLE" = "null" ]; then
    TITLE=$(grep -m1 "^# " "$draft_file" | sed 's/^# //')
    if [ -z "$TITLE" ]; then
      TITLE="$draft_name"
    fi
  fi

  # Extract SEO metadata from markdown
  SEO_TITLE=$(grep -i "^**Title Tag:**" "$draft_file" | head -1 | sed 's/\*\*Title Tag:\*\* *//i' | xargs)
  if [ -z "$SEO_TITLE" ]; then
    SEO_TITLE="$TITLE"
  fi

  if [ -z "$META_DESC" ] || [ "$META_DESC" = "null" ]; then
    META_DESC=$(grep -i "^**Meta Description:**" "$draft_file" | head -1 | sed 's/\*\*Meta Description:\*\* *//i' | xargs)
  fi

  FOCUS_KEYWORD=$(grep -i "^**Primary Keyword:**" "$draft_file" | head -1 | sed 's/\*\*Primary Keyword:\*\* *//i' | xargs)
  if [ -z "$FOCUS_KEYWORD" ]; then
    FOCUS_KEYWORD=$(grep -i "^**Focus Keyword:**" "$draft_file" | head -1 | sed 's/\*\*Focus Keyword:\*\* *//i' | xargs)
  fi

  if [ -z "$KEYWORDS" ] || [ "$KEYWORDS" = "null" ] || [ "$KEYWORDS" = "[]" ]; then
    KEYWORDS_STR=$(grep -i "^**Target Keywords:**" "$draft_file" | head -1 | sed 's/\*\*Target Keywords:\*\* *//i' | xargs)
    if [ -n "$KEYWORDS_STR" ]; then
      KEYWORDS=$(echo "$KEYWORDS_STR" | jq -R '[split(",")[] | map(select(length > 0))]')
    fi
  fi

  # Auto-detect target site if not specified
  if [ -z "$TARGET_SITE" ] || [ "$TARGET_SITE" = "null" ]; then
    # Try to extract from filename (pattern: site-keyword.md)
    SITE_PREFIX=$(echo "$draft_name" | cut -d'-' -f1)
    case "$SITE_PREFIX" in
      crashcasino|crashcasinoio)
        TARGET_SITE="crashcasino.io"
        ;;
      crashgamegambling)
        TARGET_SITE="crashgamegambling.com"
        ;;
      cryptocrash|cryptocrashgambling)
        TARGET_SITE="cryptocrashgambling.com"
        ;;
      freecrashgames)
        TARGET_SITE="freecrashgames.com"
        ;;
      aviatorcrash|aviatorcrashgame)
        TARGET_SITE="aviatorcrashgame.com"
        ;;
      *)
        # Default to crashcasino.io
        TARGET_SITE="crashcasino.io"
        ;;
    esac
  fi

  echo "Title: ${TITLE}" >> "$LOG_FILE"
  echo "SEO Title: ${SEO_TITLE}" >> "$LOG_FILE"
  echo "Focus KW: ${FOCUS_KEYWORD}" >> "$LOG_FILE"
  echo "Site: ${TARGET_SITE}" >> "$LOG_FILE"

  # Get WordPress credentials
  WP_URL=""
  WP_USER="peter"
  WP_APP=""

  case "$TARGET_SITE" in
    crashcasino.io)
      WP_URL="https://crashcasino.io"
      WP_APP="${WORDPRESS_CRASHCASINO_APP_PASSWORD:-}"
      CATEGORY="Reviews"
      ;;
    crashgamegambling.com)
      WP_URL="https://crashgamegambling.com"
      WP_APP="${WORDPRESS_CRASHGAMEGAMBLING_APP_PASSWORD:-}"
      CATEGORY="Strategy"
      ;;
    cryptocrashgambling.com)
      WP_URL="https://cryptocrashgambling.com"
      WP_APP="${WORDPRESS_CRYPTOCRASH_APP_PASSWORD:-}"
      CATEGORY="Bitcoin"
      ;;
    freecrashgames.com)
      WP_URL="https://freecrashgames.com"
      WP_APP="${WORDPRESS_FREECRASH_APP_PASSWORD:-}"
      CATEGORY="Bonuses"
      ;;
    aviatorcrashgame.com)
      WP_URL="https://aviatorcrashgame.com"
      WP_APP="${WORDPRESS_AVIATORCRASH_APP_PASSWORD:-}"
      CATEGORY="Aviator"
      ;;
    *)
      echo "WARNING: Unknown site ${TARGET_SITE}, skipping" >> "$LOG_FILE"
      ((FAILED_COUNT++))
      continue
      ;;
  esac

  # Check credentials
  if [ -z "$WP_APP" ]; then
    echo "ERROR: No WordPress credentials for ${TARGET_SITE}" >> "$LOG_FILE"
    ((FAILED_COUNT++))
    continue
  fi

  # Escape HTML for JSON
  ESCAPED_HTML=$(echo "$HTML_CONTENT" | jq -Rs .)

  # Build keywords JSON array
  KEYWORDS_JSON=$(echo "$KEYWORDS" | jq '["kw1", "kw2", "kw3"]' 2>/dev/null || echo '[]')

  # Generate schema markup
  SCHEMA_MARKUP=$(cat <<EOF
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "${TITLE}",
  "description": "${META_DESC}",
  "keywords": "${FOCUS_KEYWORD}"
}
EOF
)

  # Build full JSON payload with Yoast SEO metadata
  JSON_PAYLOAD=$(cat <<EOF
{
  "title": "${TITLE}",
  "content": ${ESCAPED_HTML},
  "excerpt": "${META_DESC}",
  "status": "publish",
  "categories": ["${CATEGORY}"],
  "meta": {
    "yoastseo": {
      "title": "${SEO_TITLE}",
      "metadesc": "${META_DESC}",
      "focuskw": "${FOCUS_KEYWORD}",
      "keywords": ${KEYWORDS_JSON}
    }
  }
}
EOF
)

  # Publish via WordPress REST API
  echo "Publishing to ${TARGET_SITE} with full metadata..." >> "$LOG_FILE"

  RESPONSE=$(curl -s -X POST "${WP_URL}/wp-json/wp/v2/posts" \
    --user "${WP_USER}:${WP_APP}" \
    -H "Content-Type: application/json" \
    -d "$JSON_PAYLOAD" 2>&1)

  # Check response
  if echo "$RESPONSE" | jq -e '.id' > /dev/null 2>&1; then
    POST_ID=$(echo "$RESPONSE" | jq -r '.id')
    POST_LINK=$(echo "$RESPONSE" | jq -r '.link // empty')
    echo "âœ… SUCCESS: Published as post #${POST_ID}" >> "$LOG_FILE"
    if [ -n "$POST_LINK" ]; then
      echo "   Link: ${POST_LINK}" >> "$LOG_FILE"
    fi
    ((PUBLISHED_COUNT++))

    # Move published draft to archive
    ARCHIVE_DIR="/root/.openclaw/workspace/drafts/published"
    mkdir -p "$ARCHIVE_DIR"
    mv "$draft_file" "${ARCHIVE_DIR}/${draft_name}.md"
    echo "   Archived: ${ARCHIVE_DIR}/${draft_name}.md" >> "$LOG_FILE"
  else
    echo "âŒ ERROR: Failed to publish" >> "$LOG_FILE"
    echo "   Response: ${RESPONSE}" >> "$LOG_FILE"
    ((FAILED_COUNT++))
  fi
done

# Summary
echo "" >> "$LOG_FILE"
echo "=== Publishing Summary ===" >> "$LOG_FILE"
echo "âœ… Published: ${PUBLISHED_COUNT}" >> "$LOG_FILE"
echo "âŒ Failed: ${FAILED_COUNT}" >> "$LOG_FILE"
echo "ðŸ“Š Total: $((PUBLISHED_COUNT + FAILED_COUNT))" >> "$LOG_FILE"

if [ "$PUBLISHED_COUNT" -gt 0 ]; then
  echo "Universal WordPress publishing complete with full HTML + SEO metadata" >> "$LOG_FILE"
  exit 0
else
  echo "ERROR: No articles published" >> "$LOG_FILE"
  exit 1
fi
