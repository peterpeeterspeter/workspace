#!/bin/bash
# FINAL WordPress Publishing Script with Proper HTML
# Uses Python markdown-to-HTML converter

TASK_ID=$1
TASK_TITLE=$2

# Source skills integration
source /root/.openclaw/workspace/agents/shared/skills-integration.sh

# Log setup
LOG_DIR="/root/.openclaw/workspace/tasks/logs"
mkdir -p "$LOG_DIR"
LOG_FILE="$LOG_DIR/${TASK_ID}.log"

echo "=== $(date '+%Y-%m-%d %H:%M:%S') ===" >> "$LOG_FILE"
echo "Vision: WordPress Publishing (PROPER HTML)" >> "$LOG_FILE"
echo "Task: ${TASK_TITLE}" >> "$LOG_FILE"

# Find draft articles
DRAFT_DIR="/root/.openclaw/workspace/drafts"

if [ ! -d "$DRAFT_DIR" ]; then
  echo "ERROR: Drafts directory not found: ${DRAFT_DIR}" >> "$LOG_FILE"
  exit 1
fi

# Find all markdown files in drafts
DRAFT_COUNT=$(find "$DRAFT_DIR" -name "*.md" -type f | wc -l)
echo "Found ${DRAFT_COUNT} draft articles" >> "$LOG_FILE"

if [ "$DRAFT_COUNT" -eq 0 ]; then
  echo "ERROR: No draft articles found to publish" >> "$LOG_FILE"
  exit 1
fi

PUBLISHED_COUNT=0
FAILED_COUNT=0

# Process each draft
for draft_file in "$DRAFT_DIR"/*.md; do
  if [ ! -f "$draft_file" ]; then
    continue
  fi

  draft_name=$(basename "$draft_file" .md)
  echo "" >> "$LOG_FILE"
  echo "Processing: ${draft_name}" >> "$LOG_FILE"

  # Convert markdown to HTML using FIXED Python script
  HTML_RESULT=$(python3 /root/.openclaw/workspace/agents/shared/md2html-fixed.py "$draft_file" 2>> "$LOG_FILE")

  # Check if conversion succeeded
  if ! echo "$HTML_RESULT" | jq -e '.html' > /dev/null 2>&1; then
    echo "ERROR: Failed to convert markdown to HTML" >> "$LOG_FILE"
    echo "$HTML_RESULT" >> "$LOG_FILE"
    ((FAILED_COUNT++))
    continue
  fi

  # Extract data
  TITLE=$(echo "$HTML_RESULT" | jq -r '.metadata.title // empty')
  HTML_CONTENT=$(echo "$HTML_RESULT" | jq -r '.html // empty')
  META_DESC=$(echo "$HTML_RESULT" | jq -r '.metadata.description // empty')
  KEYWORDS_JSON=$(echo "$HTML_RESULT" | jq -r '.metadata.keywords // []' | jq -R '[split("\n")[] | select(length > 0)]')
  TARGET_SITE=$(echo "$HTML_RESULT" | jq -r '.metadata.site // empty')

  # Default title if not found
  if [ -z "$TITLE" ] || [ "$TITLE" = "null" ]; then
    TITLE=$(grep -m1 "^# " "$draft_file" | sed 's/^# //')
    if [ -z "$TITLE" ]; then
      TITLE="$draft_name"
    fi
  fi

  # Default site if not found
  if [ -z "$TARGET_SITE" ] || [ "$TARGET_SITE" = "null" ]; then
    TARGET_SITE="crashcasino.io"
  fi

  echo "Title: ${TITLE}" >> "$LOG_FILE"
  echo "Site: ${TARGET_SITE}" >> "$LOG_FILE"

  # Get WordPress credentials
  WP_URL=""
  WP_USER="peter"
  WP_APP=""

  case "$TARGET_SITE" in
    crashcasino.io)
      WP_URL="https://crashcasino.io"
      WP_APP="${WORDPRESS_CRASHCASINO_APP_PASSWORD:-}"
      CATEGORY="Reviews"
      ;;
    cryptocrashgambling.com)
      WP_URL="https://cryptocrashgambling.com"
      WP_APP="${WORDPRESS_CRYPTOCRASH_APP_PASSWORD:-}"
      CATEGORY="Bitcoin"
      ;;
    crashgamegambling.com)
      WP_URL="https://crashgamegambling.com"
      WP_APP="${WORDPRESS_CRASHGAMEGAMBLING_APP_PASSWORD:-}"
      CATEGORY="Strategy"
      ;;
    freecrashgames.com)
      WP_URL="https://freecrashgames.com"
      WP_APP="${WORDPRESS_FREECRASH_APP_PASSWORD:-}"
      CATEGORY="Bonuses"
      ;;
    aviatorcrashgame.com)
      WP_URL="https://aviatorcrashgame.com"
      WP_APP="${WORDPRESS_AVIATORCRASH_APP_PASSWORD:-}"
      CATEGORY="Aviator"
      ;;
    *)
      echo "WARNING: Unknown site ${TARGET_SITE}, skipping" >> "$LOG_FILE"
      ((FAILED_COUNT++))
      continue
      ;;
  esac

  # Check credentials
  if [ -z "$WP_APP" ]; then
    echo "ERROR: No WordPress credentials for ${TARGET_SITE}" >> "$LOG_FILE"
    ((FAILED_COUNT++))
    continue
  fi

  # Escape HTML content for JSON
  ESCAPED_HTML=$(echo "$HTML_CONTENT" | jq -Rs .)

  # Build JSON payload
  JSON_PAYLOAD=$(cat <<EOF
{
  "title": "${TITLE}",
  "content": ${ESCAPED_HTML},
  "excerpt": "${META_DESC}",
  "status": "publish",
  "categories": ["${CATEGORY}"]
}
EOF
)

  # Publish via WordPress REST API
  echo "Publishing to ${TARGET_SITE}..." >> "$LOG_FILE"

  RESPONSE=$(curl -s -X POST "${WP_URL}/wp-json/wp/v2/posts" \
    --user "${WP_USER}:${WP_APP}" \
    -H "Content-Type: application/json" \
    -d "$JSON_PAYLOAD" 2>&1)

  # Check response
  if echo "$RESPONSE" | jq -e '.id' > /dev/null 2>&1; then
    POST_ID=$(echo "$RESPONSE" | jq -r '.id')
    POST_LINK=$(echo "$RESPONSE" | jq -r '.link // empty')
    echo "âœ… SUCCESS: Published as post #${POST_ID}" >> "$LOG_FILE"
    if [ -n "$POST_LINK" ]; then
      echo "   Link: ${POST_LINK}" >> "$LOG_FILE"
    fi
    ((PUBLISHED_COUNT++))

    # Move published draft to archive
    ARCHIVE_DIR="/root/.openclaw/workspace/drafts/published"
    mkdir -p "$ARCHIVE_DIR"
    mv "$draft_file" "${ARCHIVE_DIR}/${draft_name}.md"
    echo "   Archived: ${ARCHIVE_DIR}/${draft_name}.md" >> "$LOG_FILE"
  else
    echo "âŒ ERROR: Failed to publish" >> "$LOG_FILE"
    echo "   Response: ${RESPONSE}" >> "$LOG_FILE"
    ((FAILED_COUNT++))
  fi
done

# Summary
echo "" >> "$LOG_FILE"
echo "=== Publishing Summary ===" >> "$LOG_FILE"
echo "âœ… Published: ${PUBLISHED_COUNT}" >> "$LOG_FILE"
echo "âŒ Failed: ${FAILED_COUNT}" >> "$LOG_FILE"
echo "ðŸ“Š Total processed: $((PUBLISHED_COUNT + FAILED_COUNT))" >> "$LOG_FILE"

if [ "$PUBLISHED_COUNT" -gt 0 ]; then
  echo "WordPress publishing complete: ${PUBLISHED_COUNT} articles with proper HTML formatting" >> "$LOG_FILE"
  exit 0
else
  echo "ERROR: No articles were published successfully" >> "$LOG_FILE"
  exit 1
fi
